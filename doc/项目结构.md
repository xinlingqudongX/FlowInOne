
### 项目表
- 定义项目的名称、关联的运行节点、运行状态、创建时间、更新时间
  
// 项目总体信息
model Project {
  id           String   @id @default(uuid())
  name         String   @unique
  description  String?
  basePath     String   // 项目在本地/服务器的物理根路径
  techStack    Json     // 存储技术栈定义，如 { "backend": "NestJS", "language": "TS" }
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // 关联
  graphs       WorkflowGraph[]
  globalAssets ProjectAsset[]
}

// 项目资产总库（用于全局追踪）
model ProjectAsset {
  id           String   @id @default(uuid())
  projectId    String
  filePath     String   // 相对根路径
  fileRole     String   // IMPLEMENTATION, DOCUMENTATION, SCHEMA, TEST
  lastHash     String?  // 文件的 SHA-256 哈希值，用于防篡改校验
  
  project      Project  @relation(fields: [projectId], references: [id])
  
  @@unique([projectId, filePath])
}

// 工作流图定义（蓝图层）
model WorkflowGraph {
  id          String   @id @default(uuid())
  projectId   String
  version     String   @default("1.0.0")
  status      String   @default("ACTIVE") // ACTIVE, ARCHIVED, DRAFT
  
  project     Project  @relation(fields: [projectId], references: [id])
  nodes       TaskNode[]
  globalState Json     // 关键：项目的“黑板”数据，存储跨任务共享的变量
}

// 任务节点（UATS 2.0 混合协议核心）
model TaskNode {
  id           String   @id @default(uuid())
  graphId      String
  nodeId       String   // 业务上的唯一 ID，如 "feat_auth_01"
  type         String   // ACTION, ROUTER, EVALUATOR
  
  // 1. 并行与依赖 (JSON 骨架)
  status       String   @default("PENDING") // PENDING, RUNNING, DONE, FAILED
  dependsOn    Json     // 存储前置 node_id 的数组: ["node_01", "node_02"]
  transitions  Json     // 路由映射: { "SUCCESS": "node_03", "FAIL": "node_04" }
  
  // 2. 核心指令 (Markdown 灵魂)
  instructions Json     // 存储 { "guide": "Markdown...", "logic": "Markdown...", "criteria": "..." }
  
  // 3. RAG 增强与上下文
  ragTags      String[] // 检索标签: ["jwt", "prisma", "auth"]
  staticRefs   String[] // 硬编码引用的文档路径
  
  // 4. 资产约束 (Assets Layer)
  assetScope   String?  // 该任务允许操作的物理目录前缀
  expectedArtifacts Json // 预期产出的文件列表及约束描述
  
  // 执行数据记录
  aiOutput     String?  @db.Text // AI 生成的完整原始 Markdown
  errorLog     String?  @db.Text
  
  graph        WorkflowGraph @relation(fields: [graphId], references: [id])
  outputs      TaskOutput[]

  @@unique([graphId, nodeId])
}

// 任务产出资产关联（物理证据）
model TaskOutput {
  id          String   @id @default(uuid())
  nodeId      String
  filePath    String   // 本次任务实际改动或创建的文件
  actionType  String   // CREATE, UPDATE, DELETE
  diffSummary String?  @db.Text // 可选：记录本次改动的简要描述
  
  task        TaskNode @relation(fields: [nodeId], references: [id])
}